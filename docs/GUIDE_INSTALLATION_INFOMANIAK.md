# üöÄ Guide Pas-√†-Pas : Installation PostgreSQL sur Infomaniak

**Date :** 31 octobre 2025  
**Objectif :** Configurer votre Serveur Cloud Manag√© Infomaniak pour SelfKey

---

## üìã Pr√©requis

‚úÖ Vous avez command√© le **Serveur Cloud Manag√©** (Cloud M)  
‚úÖ Vous avez re√ßu l'email de confirmation d'Infomaniak  
‚è≥ Attendre 1-2 heures que le serveur soit provisionn√©

---

## üéØ √âtape 1 : Acc√©der au Manager Infomaniak (5 min)

### 1.1 Se connecter au Manager

1. Aller sur : **https://manager.infomaniak.com**
2. Se connecter avec vos identifiants Infomaniak
3. Dans le menu lat√©ral gauche, cliquer sur **"Cloud Serveur"** ou **"VPS/Serveur Cloud"**

### 1.2 V√©rifier que votre serveur est actif

Vous devriez voir votre nouveau serveur avec :

- ‚úÖ Statut : **"Actif"** ou **"Running"**
- üìç IP publique : `XXX.XXX.XXX.XXX`
- üíæ Syst√®me : Ubuntu 22.04 ou 24.04

**Si le serveur est en cours de provisionnement :**

- √âtat : "En cours de cr√©ation"
- ‚è≥ Attendre 30-60 minutes
- üìß Vous recevrez un email quand c'est pr√™t

---

## üîë √âtape 2 : Obtenir les Acc√®s SSH (5 min)

### 2.1 Trouver vos identifiants SSH

Dans le Manager Infomaniak, cliquer sur votre serveur, puis :

1. Onglet **"Acc√®s SSH"** ou **"Connexion"**
2. Vous devriez voir :
   ```
   H√¥te : XXX.XXX.XXX.XXX (votre IP)
   Utilisateur : root
   Mot de passe : [Cliquer pour r√©v√©ler]
   ```

**Option A : Mot de passe**

- Cliquer sur **"Afficher le mot de passe"**
- Le copier dans un endroit s√ªr (ex: 1Password, Bitwarden)

**Option B : Cl√© SSH** (plus s√©curis√©)

- Si vous avez une cl√© SSH configur√©e, l'utiliser
- Sinon, utiliser le mot de passe pour l'instant

### 2.2 Tester la connexion SSH

**Sur macOS (Terminal) :**

```bash
# Ouvrir le Terminal (Cmd + Espace, taper "Terminal")
ssh root@XXX.XXX.XXX.XXX

# Remplacer XXX.XXX.XXX.XXX par votre vraie IP
# Exemple : ssh root@185.123.45.67
```

Quand on vous demande :

```
Are you sure you want to continue connecting (yes/no/[fingerprint])?
```

Taper : **`yes`** puis **Entr√©e**

Puis entrer le **mot de passe** quand demand√©.

**‚úÖ Si vous voyez ceci, c'est bon :**

```
Welcome to Ubuntu 22.04 LTS
root@cloud-server:~#
```

---

## üì¶ √âtape 3 : Mettre √† Jour le Syst√®me (5 min)

Une fois connect√© en SSH, ex√©cuter ces commandes une par une :

```bash
# Mettre √† jour la liste des paquets
apt update

# Mettre √† jour tous les paquets install√©s
apt upgrade -y

# Installer les outils de base
apt install -y curl wget gnupg2 software-properties-common apt-transport-https ca-certificates
```

**Attendre que √ßa se termine** (2-5 minutes selon la connexion).

---

## üêò √âtape 4 : Installer PostgreSQL 16 (10 min)

### 4.1 Ajouter le d√©p√¥t officiel PostgreSQL

```bash
# Importer la cl√© GPG du d√©p√¥t PostgreSQL
curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc | gpg --dearmor -o /usr/share/keyrings/postgresql-keyring.gpg

# Ajouter le d√©p√¥t PostgreSQL
echo "deb [signed-by=/usr/share/keyrings/postgresql-keyring.gpg] http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" | tee /etc/apt/sources.list.d/pgdg.list

# Mettre √† jour la liste des paquets
apt update
```

### 4.2 Installer PostgreSQL 16

```bash
# Installer PostgreSQL 16 et ses outils
apt install -y postgresql-16 postgresql-contrib-16

# V√©rifier que PostgreSQL est bien install√©
psql --version
# Devrait afficher : psql (PostgreSQL) 16.x
```

### 4.3 V√©rifier que PostgreSQL fonctionne

```bash
# V√©rifier le statut
systemctl status postgresql

# Devrait afficher : Active: active (running)
# Presser "q" pour quitter
```

**‚úÖ Si vous voyez "active (running)", PostgreSQL est install√© avec succ√®s !**

---

## üîß √âtape 5 : Configurer PostgreSQL pour l'Acc√®s Externe (10 min)

Par d√©faut, PostgreSQL n'accepte que les connexions locales. On va permettre les connexions depuis Vercel.

### 5.1 Configurer l'√©coute sur toutes les interfaces

```bash
# √âditer le fichier de configuration
nano /etc/postgresql/16/main/postgresql.conf
```

**Dans l'√©diteur nano :**

1. Presser **`Ctrl + W`** (rechercher)
2. Taper : **`listen_addresses`**
3. Presser **Entr√©e**

Vous devriez voir une ligne comme :

```
#listen_addresses = 'localhost'
```

**Modifier cette ligne pour :**

```
listen_addresses = '*'
```

**Important :**

- Enlever le **`#`** au d√©but (d√©commenter)
- Remplacer **`'localhost'`** par **`'*'`**

**Sauvegarder :**

- Presser **`Ctrl + X`**
- Taper **`Y`** (pour Yes)
- Presser **Entr√©e**

### 5.2 Autoriser les connexions externes

```bash
# √âditer le fichier d'authentification
nano /etc/postgresql/16/main/pg_hba.conf
```

**Aller √† la fin du fichier :**

- Presser **`Ctrl + End`** (ou faire d√©filer avec les fl√®ches)

**Ajouter cette ligne √† la fin :**

```
host    all             all             0.0.0.0/0               scram-sha-256
```

**Explication :**

- `host` = connexion TCP/IP
- `all` = toutes les bases de donn√©es
- `all` = tous les utilisateurs
- `0.0.0.0/0` = depuis n'importe quelle IP
- `scram-sha-256` = m√©thode d'authentification s√©curis√©e

**Sauvegarder :**

- Presser **`Ctrl + X`**
- Taper **`Y`**
- Presser **Entr√©e**

### 5.3 Red√©marrer PostgreSQL

```bash
# Red√©marrer pour appliquer les changements
systemctl restart postgresql

# V√©rifier que √ßa a bien red√©marr√©
systemctl status postgresql
# Devrait afficher : Active: active (running)
```

---

## üë§ √âtape 6 : Cr√©er l'Utilisateur et la Base de Donn√©es (5 min)

### 6.1 Se connecter √† PostgreSQL

```bash
# Se connecter en tant que superuser postgres
sudo -u postgres psql
```

Vous devriez voir :

```
postgres=#
```

### 6.2 Cr√©er l'utilisateur pour SelfKey

**Dans le terminal PostgreSQL, taper :**

```sql
-- Cr√©er un utilisateur avec un mot de passe s√©curis√©
CREATE USER selfkey_user WITH PASSWORD 'VotreMotDePasseSecurise123!';

-- Donner les privil√®ges de cr√©ation de base de donn√©es
ALTER USER selfkey_user CREATEDB;
```

**‚ö†Ô∏è IMPORTANT : Choisir un mot de passe fort !**

- Minimum 20 caract√®res
- M√©lange de majuscules, minuscules, chiffres, symboles
- Exemple : `Sk2025!PostgreSQL@Infomaniak#Secure`

**üìù NOTER LE MOT DE PASSE :** Vous en aurez besoin pour l'URL de connexion !

### 6.3 Cr√©er la base de donn√©es

```sql
-- Cr√©er la base de donn√©es SelfKey
CREATE DATABASE selfkey_production OWNER selfkey_user;

-- Donner tous les privil√®ges
GRANT ALL PRIVILEGES ON DATABASE selfkey_production TO selfkey_user;

-- Afficher les bases de donn√©es pour v√©rifier
\l
```

Vous devriez voir `selfkey_production` dans la liste.

### 6.4 Quitter PostgreSQL

```sql
-- Quitter
\q
```

---

## üî• √âtape 7 : Configurer le Firewall (5 min)

### 7.1 Installer UFW (firewall simple)

```bash
# Installer UFW
apt install -y ufw
```

### 7.2 Configurer les r√®gles

```bash
# Autoriser SSH (IMPORTANT : avant d'activer le firewall !)
ufw allow 22/tcp

# Autoriser PostgreSQL
ufw allow 5432/tcp

# Activer le firewall
ufw enable

# Confirmer avec 'y' quand demand√©
```

### 7.3 V√©rifier les r√®gles

```bash
# Afficher les r√®gles actives
ufw status

# Devrait afficher :
# Status: active
# 22/tcp                     ALLOW       Anywhere
# 5432/tcp                   ALLOW       Anywhere
```

---

## üß™ √âtape 8 : Tester la Connexion (5 min)

### 8.1 Construire l'URL de connexion

**Format de l'URL :**

```
postgresql://USERNAME:PASSWORD@HOST:PORT/DATABASE?sslmode=require
```

**Remplacer par vos vraies valeurs :**

```bash
# Exemple avec vos informations :
postgresql://selfkey_user:Sk2025!PostgreSQL@Infomaniak#Secure@185.123.45.67:5432/selfkey_production?sslmode=require
```

**Composants :**

- `selfkey_user` = Nom d'utilisateur cr√©√© √† l'√©tape 6
- `Sk2025!PostgreSQL@Infomaniak#Secure` = Mot de passe choisi (bien encoder les caract√®res sp√©ciaux !)
- `185.123.45.67` = IP de votre serveur Infomaniak
- `5432` = Port PostgreSQL
- `selfkey_production` = Nom de la base de donn√©es
- `?sslmode=require` = Force SSL (s√©curit√©)

**‚ö†Ô∏è Encoder les caract√®res sp√©ciaux dans le mot de passe :**

- `@` ‚Üí `%40`
- `#` ‚Üí `%23`
- `!` ‚Üí `%21`
- `$` ‚Üí `%24`

**Exemple encod√© :**

```
postgresql://selfkey_user:Sk2025%21PostgreSQL%40Infomaniak%23Secure@185.123.45.67:5432/selfkey_production?sslmode=require
```

### 8.2 Tester depuis votre Mac (localement)

**Installer psql sur votre Mac (si pas d√©j√† fait) :**

```bash
# Avec Homebrew
brew install postgresql@16
```

**Tester la connexion :**

```bash
# Remplacer par votre vraie URL
psql "postgresql://selfkey_user:MOT_DE_PASSE@185.123.45.67:5432/selfkey_production?sslmode=require"
```

**‚úÖ Si √ßa fonctionne, vous verrez :**

```
selfkey_production=>
```

**Tester une requ√™te :**

```sql
SELECT version();
-- Devrait afficher PostgreSQL 16.x

\q
-- Pour quitter
```

---

## üîê √âtape 9 : S√©curiser PostgreSQL (10 min)

### 9.1 Cr√©er un certificat SSL auto-sign√©

```bash
# Se connecter au serveur SSH
ssh root@XXX.XXX.XXX.XXX

# G√©n√©rer le certificat SSL
cd /var/lib/postgresql/16/main/

# Cr√©er le certificat (valide 10 ans)
openssl req -new -x509 -days 3650 -nodes -text \
  -out server.crt \
  -keyout server.key \
  -subj "/CN=selfkey-db.infomaniak"

# D√©finir les permissions
chmod 600 server.key
chown postgres:postgres server.key server.crt
```

### 9.2 Activer SSL dans PostgreSQL

```bash
# √âditer la configuration
nano /etc/postgresql/16/main/postgresql.conf
```

**Rechercher et modifier :**

```
ssl = on
ssl_cert_file = '/var/lib/postgresql/16/main/server.crt'
ssl_key_file = '/var/lib/postgresql/16/main/server.key'
```

**Sauvegarder et red√©marrer :**

```bash
systemctl restart postgresql
```

### 9.3 Limiter les connexions aux IPs Vercel (optionnel mais recommand√©)

**Obtenir les IPs de Vercel :**

```bash
curl https://api.vercel.com/v1/integrations/deployment-ips
```

**√âditer pg_hba.conf pour restreindre :**

```bash
nano /etc/postgresql/16/main/pg_hba.conf
```

**Remplacer la ligne `0.0.0.0/0` par les IPs Vercel sp√©cifiques.**

---

## üìù √âtape 10 : Appliquer les Migrations Prisma (15 min)

### 10.1 Tester en local d'abord

**Sur votre Mac, dans le projet SelfKey :**

```bash
# Cr√©er un fichier .env.infomaniak (ne pas commit !)
echo 'DATABASE_URL="postgresql://selfkey_user:MOT_DE_PASSE@185.123.45.67:5432/selfkey_production?sslmode=require"' > .env.infomaniak

# Tester la connexion Prisma
npx prisma db pull --schema=./prisma/schema.prisma

# Appliquer les migrations
npx prisma migrate deploy
```

**‚úÖ Si tout fonctionne :**

```
‚úî Migrations applied:
  20250623132642_add_room_model_and_update_relations
  20250623145703_add_guests_to_booking
  ...
  (toutes vos migrations)
```

### 10.2 V√©rifier que les tables sont cr√©√©es

```bash
# Se reconnecter √† la base
psql "postgresql://selfkey_user:MOT_DE_PASSE@185.123.45.67:5432/selfkey_production?sslmode=require"

# Lister les tables
\dt

# Devrait afficher toutes vos tables :
# user, account, session, establishments, bookings, rooms, etc.

# Quitter
\q
```

---

## üöÄ √âtape 11 : Migrer les Donn√©es de Neon (30 min)

### 11.1 Backup de la base Neon actuelle

```bash
# Sur votre Mac
# Exporter toutes les donn√©es de Neon
pg_dump $DATABASE_URL > backup_neon_$(date +%Y%m%d).sql

# V√©rifier la taille du fichier
ls -lh backup_neon_*.sql
```

### 11.2 Importer dans Infomaniak

**Option A : Import direct (si petit fichier < 100 MB)**

```bash
psql "postgresql://selfkey_user:MOT_DE_PASSE@185.123.45.67:5432/selfkey_production?sslmode=require" < backup_neon_20251031.sql
```

**Option B : Via SCP (si gros fichier)**

```bash
# Copier le fichier sur le serveur
scp backup_neon_20251031.sql root@185.123.45.67:/tmp/

# Se connecter au serveur
ssh root@185.123.45.67

# Importer
sudo -u postgres psql selfkey_production < /tmp/backup_neon_20251031.sql

# Nettoyer
rm /tmp/backup_neon_20251031.sql
```

### 11.3 V√©rifier l'int√©grit√© des donn√©es

```bash
# Se connecter √† la base
psql "postgresql://selfkey_user:MOT_DE_PASSE@185.123.45.67:5432/selfkey_production?sslmode=require"

# Compter les lignes
SELECT 'users' as table_name, COUNT(*) as count FROM "user"
UNION ALL
SELECT 'establishments', COUNT(*) FROM "establishments"
UNION ALL
SELECT 'bookings', COUNT(*) FROM "bookings"
UNION ALL
SELECT 'rooms', COUNT(*) FROM "rooms";

-- Comparer avec les chiffres de Neon !
```

---

## üîÑ √âtape 12 : Mettre √† Jour Vercel (10 min)

### 12.1 Ajouter la variable d'environnement

**Option A : Via l'interface web Vercel**

1. Aller sur : https://vercel.com/[votre-compte]/selfkey/settings/environment-variables
2. Cliquer sur **"Add New"**
3. **Key :** `DATABASE_URL`
4. **Value :** Coller votre URL compl√®te Infomaniak
5. **Environments :** Cocher **"Production"** uniquement (pour l'instant)
6. Cliquer **"Save"**

**Option B : Via CLI Vercel**

```bash
# Se connecter √† Vercel
npx vercel login

# Ajouter la variable (en mode interactif)
npx vercel env add DATABASE_URL production

# Coller l'URL quand demand√©
```

### 12.2 Red√©ployer en production

```bash
# Forcer un nouveau d√©ploiement
npx vercel --prod

# Ou via Git
git commit --allow-empty -m "Migrate to Infomaniak PostgreSQL"
git push origin main
```

### 12.3 V√©rifier le d√©ploiement

1. Attendre la fin du d√©ploiement (~2-3 minutes)
2. Aller sur votre site : https://www.selfkey.ch
3. Tester :
   - ‚úÖ Connexion (login)
   - ‚úÖ Dashboard admin
   - ‚úÖ Cr√©er un test establishment
   - ‚úÖ Voir les r√©servations existantes

**Si tout fonctionne ‚Üí Migration r√©ussie ! üéâ**

---

## üìä √âtape 13 : Monitoring Post-Migration (7 jours)

### 13.1 Surveiller les logs Vercel

```bash
# Suivre les logs en temps r√©el
npx vercel logs --follow

# Filtrer les erreurs PostgreSQL
npx vercel logs --follow | grep -i "P1001\|prisma\|database"
```

### 13.2 M√©triques √† surveiller

**Via Manager Infomaniak :**

1. Aller dans **Cloud Serveur** > Votre serveur
2. Onglet **"Monitoring"**
3. Surveiller :
   - üìä CPU Usage (< 50% en moyenne)
   - üíæ RAM Usage (< 3 GB sur 4 GB)
   - üíø Disk Usage (< 20 GB sur 40 GB)

**Via PostgreSQL :**

```bash
# Se connecter au serveur
ssh root@185.123.45.67

# Surveiller les connexions actives
sudo -u postgres psql -c "SELECT count(*) FROM pg_stat_activity WHERE state = 'active';"

# Voir les requ√™tes lentes
sudo -u postgres psql -c "SELECT query, calls, mean_exec_time FROM pg_stat_statements ORDER BY mean_exec_time DESC LIMIT 10;"
```

### 13.3 Alertes √† configurer

**Email d'alerte si probl√®me :**

```bash
# Installer mail utils
apt install -y mailutils

# Script d'alerte (√† cr√©er)
nano /root/check_db.sh
```

Contenu du script :

```bash
#!/bin/bash
CONNECTIONS=$(sudo -u postgres psql -t -c "SELECT count(*) FROM pg_stat_activity;")
if [ "$CONNECTIONS" -gt 80 ]; then
  echo "ALERTE: $CONNECTIONS connexions actives sur PostgreSQL" | mail -s "SelfKey DB Alert" votre-email@example.com
fi
```

Rendre ex√©cutable et ajouter au cron :

```bash
chmod +x /root/check_db.sh
crontab -e
# Ajouter : */5 * * * * /root/check_db.sh
```

---

## üéØ Checklist Finale

### Avant de consid√©rer la migration termin√©e :

- [ ] ‚úÖ PostgreSQL 16 install√© et actif
- [ ] ‚úÖ Utilisateur `selfkey_user` cr√©√©
- [ ] ‚úÖ Base `selfkey_production` cr√©√©e
- [ ] ‚úÖ Migrations Prisma appliqu√©es
- [ ] ‚úÖ Donn√©es migr√©es de Neon
- [ ] ‚úÖ Nombre de lignes identique (users, bookings, etc.)
- [ ] ‚úÖ Firewall UFW configur√©
- [ ] ‚úÖ SSL activ√© sur PostgreSQL
- [ ] ‚úÖ Variable `DATABASE_URL` mise √† jour sur Vercel
- [ ] ‚úÖ Site en production fonctionne
- [ ] ‚úÖ Test de connexion r√©ussi
- [ ] ‚úÖ Test de cr√©ation d'√©tablissement r√©ussi
- [ ] ‚úÖ Test de r√©servation r√©ussi
- [ ] ‚úÖ Emails de confirmation envoy√©s
- [ ] ‚úÖ Monitoring actif (7 jours)

---

## üÜò D√©pannage

### Erreur : "Connection refused"

**Solution :**

```bash
# V√©rifier que PostgreSQL √©coute bien
ss -tlnp | grep 5432
# Devrait afficher : LISTEN 0.0.0.0:5432

# V√©rifier le firewall
ufw status | grep 5432
```

### Erreur : "Authentication failed"

**Solution :**

```bash
# V√©rifier le mot de passe
sudo -u postgres psql
ALTER USER selfkey_user WITH PASSWORD 'NouveauMotDePasse';
\q
```

### Erreur : "Too many connections"

**Solution :**

```bash
# Augmenter la limite
nano /etc/postgresql/16/main/postgresql.conf
# Modifier : max_connections = 200
systemctl restart postgresql
```

### Site lent apr√®s migration

**Solutions :**

1. V√©rifier la latence : `ping 185.123.45.67`
2. Activer les index manquants
3. Consid√©rer Prisma Accelerate (pooling)

---

## üìû Support

### Infomaniak

- **T√©l√©phone :** +41 22 820 35 44 (7/7)
- **Email :** support@infomaniak.com
- **Chat :** https://www.infomaniak.com/fr/support

### Prisma

- **Documentation :** https://www.prisma.io/docs
- **Discord :** https://pris.ly/discord
- **GitHub Issues :** https://github.com/prisma/prisma/issues

### PostgreSQL

- **Documentation :** https://www.postgresql.org/docs/16/
- **Mailing list :** https://www.postgresql.org/list/

---

## üéâ F√©licitations !

Si vous √™tes arriv√© jusqu'ici et que tous les tests passent :

**‚úÖ Votre base de donn√©es SelfKey est maintenant h√©berg√©e 100% en Suisse !**

Avantages obtenus :

- üá®üá≠ Souverainet√© des donn√©es garantie
- üîí Conformit√© LPD/RGPD renforc√©e
- üìû Support de qualit√© en fran√ßais
- üöÄ Infrastructure stable et performante
- üí™ Contr√¥le total sur votre base de donn√©es

**Prochaine √©tape :** Communiquer cet avantage √† vos clients ! üì¢

---

_Guide cr√©√© le 31 octobre 2025_  
_Pour SelfKey - H√©bergement 100% Suisse_
