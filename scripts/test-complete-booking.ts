/**
 * üß™ Script de test complet d'une r√©servation
 *
 * Ce script simule une r√©servation compl√®te du d√©but √† la fin :
 * 1. V√©rifie la disponibilit√© d'une chambre
 * 2. Cr√©e un Payment Intent Stripe (mode test)
 * 3. Simule un paiement r√©ussi
 * 4. D√©clenche le webhook pour cr√©er la r√©servation
 * 5. Envoie l'email de confirmation
 * 6. Affiche le r√©sum√© complet
 *
 * Usage: npx tsx scripts/test-complete-booking.ts [langue]
 *
 * Exemples:
 *   npx tsx scripts/test-complete-booking.ts fr
 *   npx tsx scripts/test-complete-booking.ts en
 *   npx tsx scripts/test-complete-booking.ts de
 */

import { PrismaClient } from "@prisma/client";

const prisma = new PrismaClient();

interface TestBookingConfig {
  locale: "fr" | "en" | "de";
  email: string;
  firstName: string;
  lastName: string;
  phone: string;
  hasDog?: boolean;
  adults: number;
  children: number;
  daysFromNow: number; // Check-in dans X jours
  numberOfNights: number;
}

const DEFAULT_CONFIG: TestBookingConfig = {
  locale: "fr",
  email: process.env.TEST_EMAIL || "perrottet.guillaume.1997@gmail.com",
  firstName: "Guillaume",
  lastName: "Perrottet",
  phone: "+41791234567",
  hasDog: undefined, // undefined = g√©n√©ral, true = avec chien, false = sans chien
  adults: 2,
  children: 0,
  daysFromNow: 7,
  numberOfNights: 3,
};

async function testCompleteBooking(config: TestBookingConfig = DEFAULT_CONFIG) {
  console.log("\n" + "=".repeat(70));
  console.log("üß™ TEST COMPLET D'UNE R√âSERVATION");
  console.log("=".repeat(70) + "\n");

  const flag =
    config.locale === "fr" ? "üá´üá∑" : config.locale === "en" ? "üá¨üáß" : "üá©üá™";
  const localeName =
    config.locale === "fr"
      ? "Fran√ßais"
      : config.locale === "en"
        ? "English"
        : "Deutsch";

  console.log(`${flag} Langue: ${localeName}`);
  console.log(`üìß Email: ${config.email}`);
  console.log(`üë§ Client: ${config.firstName} ${config.lastName}`);
  console.log(
    `üêï Chien: ${config.hasDog === true ? "Oui" : config.hasDog === false ? "Non" : "Non sp√©cifi√© (g√©n√©ral)"}`
  );
  console.log(
    `üë• Voyageurs: ${config.adults} adulte(s), ${config.children} enfant(s)`
  );
  console.log(`üìÖ Check-in: Dans ${config.daysFromNow} jours`);
  console.log(`üåô Dur√©e: ${config.numberOfNights} nuit(s)\n`);

  try {
    // ==========================================
    // √âTAPE 1: Trouver un √©tablissement et une chambre
    // ==========================================
    console.log("üìç √âTAPE 1: Recherche d'un √©tablissement et d'une chambre...");

    const establishment = await prisma.establishment.findFirst({
      where: {
        slug: { not: undefined },
        stripeAccountId: { not: null },
      },
    });

    if (!establishment || !establishment.slug) {
      throw new Error("‚ùå Aucun √©tablissement trouv√©");
    }

    console.log(
      `   ‚úÖ √âtablissement: ${establishment.name} (${establishment.slug})`
    );

    const room = await prisma.room.findFirst({
      where: {
        hotelSlug: establishment.slug,
        isActive: true,
      },
    });

    if (!room) {
      throw new Error("‚ùå Aucune chambre active trouv√©e");
    }

    console.log(`   ‚úÖ Chambre: ${room.name} - ${room.price} CHF/nuit\n`);

    // ==========================================
    // √âTAPE 2: Calculer les dates et le prix
    // ==========================================
    console.log("üí∞ √âTAPE 2: Calcul des dates et du prix...");

    const checkInDate = new Date();
    checkInDate.setDate(checkInDate.getDate() + config.daysFromNow);
    checkInDate.setHours(14, 0, 0, 0);

    const checkOutDate = new Date(checkInDate);
    checkOutDate.setDate(checkOutDate.getDate() + config.numberOfNights);
    checkOutDate.setHours(12, 0, 0, 0);

    const basePrice = room.price * config.numberOfNights;
    const commission = basePrice * (establishment.commissionRate / 100);
    const fixedFee = establishment.fixedFee;
    const totalPrice = basePrice + commission + fixedFee;

    console.log(`   üìÖ Check-in: ${checkInDate.toLocaleDateString("fr-CH")}`);
    console.log(`   üìÖ Check-out: ${checkOutDate.toLocaleDateString("fr-CH")}`);
    console.log(`   üíµ Prix de base: ${basePrice.toFixed(2)} CHF`);
    console.log(`   üíµ Commission: ${commission.toFixed(2)} CHF`);
    console.log(`   üíµ Frais fixes: ${fixedFee.toFixed(2)} CHF`);
    console.log(`   üíµ TOTAL: ${totalPrice.toFixed(2)} CHF\n`);

    // ==========================================
    // √âTAPE 3: Cr√©er le Payment Intent
    // ==========================================
    console.log("üí≥ √âTAPE 3: Cr√©ation du Payment Intent Stripe...");

    const paymentResponse = await fetch(
      `http://localhost:3000/api/establishments/${establishment.slug}/bookings`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          roomId: room.id,
          checkInDate: checkInDate.toISOString(),
          checkOutDate: checkOutDate.toISOString(),
          adults: config.adults,
          children: config.children,
          clientFirstName: config.firstName,
          clientLastName: config.lastName,
          clientEmail: config.email,
          clientPhone: config.phone,
          clientBirthDate: "1997-01-01",
          clientBirthPlace: "Fribourg",
          clientAddress: "Rue du Test 123",
          clientPostalCode: "1700",
          clientCity: "Fribourg",
          clientCountry: "Suisse",
          clientIdNumber: "TEST123456",
          clientIdType: "Carte d'identit√©",
          clientVehicleNumber: "FR-123456",
          expectedPrice: basePrice,
          selectedPricingOptions: {},
          hasDog: config.hasDog,
          bookingLocale: config.locale,
        }),
      }
    );

    if (!paymentResponse.ok) {
      const error = await paymentResponse.json();
      throw new Error(`Erreur Payment Intent: ${JSON.stringify(error)}`);
    }

    const { paymentIntentId } = await paymentResponse.json();
    console.log(`   ‚úÖ Payment Intent cr√©√©: ${paymentIntentId}\n`);

    // ==========================================
    // √âTAPE 4: Simuler le paiement (confirmer le PI)
    // ==========================================
    console.log("‚úÖ √âTAPE 4: Simulation du paiement Stripe...");
    console.log(
      `   ‚ö†Ô∏è  En mode test, vous devez confirmer manuellement le Payment Intent`
    );
    console.log(
      `   üí° Ouvrez Stripe Dashboard > Paiements > Recherchez ${paymentIntentId}`
    );
    console.log(
      `   üí° Ou utilisez la CLI: stripe payment_intents confirm ${paymentIntentId}\n`
    );

    console.log("   ‚è≥ Attente de 5 secondes pour le webhook...");
    await new Promise((resolve) => setTimeout(resolve, 5000));

    // ==========================================
    // √âTAPE 5: V√©rifier la cr√©ation de la r√©servation
    // ==========================================
    console.log("\nüì¶ √âTAPE 5: V√©rification de la r√©servation...");

    const booking = await prisma.booking.findFirst({
      where: {
        stripePaymentIntentId: paymentIntentId,
      },
      include: {
        room: true,
      },
    });

    if (!booking) {
      console.log(`   ‚ö†Ô∏è  R√©servation pas encore cr√©√©e (webhook en attente)`);
      console.log(
        `   üí° La r√©servation sera cr√©√©e automatiquement par le webhook Stripe`
      );
      console.log(`   üí° En production, cela prend quelques secondes\n`);

      console.log("üîç Pour tester en local avec les webhooks:");
      console.log(
        "   1. Installez Stripe CLI: brew install stripe/stripe-cli/stripe"
      );
      console.log(
        "   2. Lancez: stripe listen --forward-to localhost:3000/api/webhooks/stripe"
      );
      console.log("   3. Relancez ce script\n");

      return;
    }

    console.log(`   ‚úÖ R√©servation cr√©√©e: #${booking.bookingNumber}`);
    console.log(`   üìß Email: ${booking.clientEmail}`);
    console.log(
      `   üåê Langue: ${booking.bookingLocale?.toUpperCase() || "FR"}`
    );
    console.log(
      `   üêï Chien: ${booking.hasDog === true ? "Oui" : booking.hasDog === false ? "Non" : "Non sp√©cifi√©"}\n`
    );

    // ==========================================
    // √âTAPE 6: Envoyer l'email de confirmation
    // ==========================================
    console.log("üìß √âTAPE 6: Envoi de l'email de confirmation...");

    const emailResponse = await fetch(
      `http://localhost:3000/api/bookings/${booking.id}/send-confirmation`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ method: "email" }),
      }
    );

    if (!emailResponse.ok) {
      const error = await emailResponse.json();
      throw new Error(`Erreur email: ${JSON.stringify(error)}`);
    }

    console.log(`   ‚úÖ Email de confirmation envoy√© !\n`);

    // ==========================================
    // R√âSUM√â FINAL
    // ==========================================
    console.log("=".repeat(70));
    console.log("‚ú® TEST TERMIN√â AVEC SUCC√àS !");
    console.log("=".repeat(70) + "\n");

    console.log("üìã R√âSUM√â DE LA R√âSERVATION:");
    console.log(`   ‚Ä¢ Num√©ro: #${booking.bookingNumber}`);
    console.log(`   ‚Ä¢ √âtablissement: ${establishment.name}`);
    console.log(`   ‚Ä¢ Chambre: ${booking.room?.name}`);
    console.log(
      `   ‚Ä¢ Client: ${booking.clientFirstName} ${booking.clientLastName}`
    );
    console.log(`   ‚Ä¢ Email: ${booking.clientEmail}`);
    console.log(
      `   ‚Ä¢ Check-in: ${booking.checkInDate.toLocaleDateString("fr-CH")}`
    );
    console.log(
      `   ‚Ä¢ Check-out: ${booking.checkOutDate.toLocaleDateString("fr-CH")}`
    );
    console.log(`   ‚Ä¢ Montant: ${booking.amount.toFixed(2)} CHF`);
    console.log(`   ‚Ä¢ Statut: ${booking.paymentStatus}`);
    console.log(`   ‚Ä¢ Langue: ${flag} ${booking.bookingLocale?.toUpperCase()}`);
    console.log(
      `   ‚Ä¢ Chien: ${booking.hasDog === true ? "‚úÖ Oui" : booking.hasDog === false ? "‚ùå Non" : "‚ûñ Non sp√©cifi√©"}\n`
    );

    console.log("üì¨ V√âRIFICATIONS:");
    console.log(`   [ ] V√©rifiez votre email: ${config.email}`);
    console.log(`   [ ] L'email est dans la bonne langue (${localeName})`);
    console.log(`   [ ] Les informations sont correctes`);
    console.log(`   [ ] Le design s'affiche correctement`);
    console.log(`   [ ] La r√©servation appara√Æt dans l'admin\n`);

    console.log("üîó LIENS UTILES:");
    console.log(
      `   ‚Ä¢ Admin: http://localhost:3000/admin/${establishment.slug}`
    );
    console.log(
      `   ‚Ä¢ Stripe Dashboard: https://dashboard.stripe.com/test/payments/${paymentIntentId}`
    );
    console.log(`   ‚Ä¢ Invoice: http://localhost:3000/invoice/${booking.id}\n`);

    // Option: nettoyer la r√©servation de test
    if (process.env.CLEANUP_TEST_BOOKING === "true") {
      console.log("üßπ Nettoyage de la r√©servation de test...");
      await prisma.booking.delete({ where: { id: booking.id } });
      console.log("   ‚úÖ R√©servation supprim√©e\n");
    } else {
      console.log(
        "üíæ R√©servation conserv√©e (ajoutez CLEANUP_TEST_BOOKING=true pour la supprimer)\n"
      );
    }
  } catch (error) {
    console.error("\n‚ùå ERREUR LORS DU TEST:", error);
    throw error;
  } finally {
    await prisma.$disconnect();
  }
}

// ==========================================
// EX√âCUTION DU SCRIPT
// ==========================================
const locale = (process.argv[2] || "fr") as "fr" | "en" | "de";
const config: TestBookingConfig = {
  ...DEFAULT_CONFIG,
  locale,
};

// Option: tester avec un chien
if (process.argv[3] === "withDog") {
  config.hasDog = true;
} else if (process.argv[3] === "withoutDog") {
  config.hasDog = false;
}

testCompleteBooking(config).catch((error) => {
  console.error(error);
  process.exit(1);
});
