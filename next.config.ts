import type { NextConfig } from "next";
import { execSync } from "child_process";

// G√©n√©rer le client Prisma avant le build
if (
  process.env.NODE_ENV === "production" ||
  process.env.VERCEL ||
  process.env.CI
) {
  try {
    console.log("üîÑ Generating Prisma Client...");
    execSync("npx prisma generate", { stdio: "inherit" });
    console.log("‚úÖ Prisma Client generated successfully");
  } catch (error) {
    console.error("‚ùå Prisma generate failed:", error);
    // Ne pas throw l'erreur car elle sera g√©r√©e par le script de build
  }
}

const nextConfig: NextConfig = {
  // Configuration pour g√©rer les domaines multiples
  async headers() {
    return [
      {
        // Permettre les appels API entre selfcamp.ch et selfkey.ch
        source: "/api/:path*",
        headers: [
          {
            key: "Access-Control-Allow-Origin",
            value: "https://selfcamp.ch",
          },
          {
            key: "Access-Control-Allow-Methods",
            value: "GET, POST, PUT, DELETE, OPTIONS",
          },
          {
            key: "Access-Control-Allow-Headers",
            value: "Content-Type, Authorization",
          },
        ],
      },
    ];
  },
  // G√©rer les rewrites pour les diff√©rents domaines
  async rewrites() {
    return [
      {
        source: "/:path*",
        destination: "/:path*",
        has: [
          {
            type: "host",
            value: "selfcamp.ch",
          },
        ],
      },
    ];
  },
};

export default nextConfig;
